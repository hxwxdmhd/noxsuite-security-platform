{%% extends "base.html" %%}

{%% block title %%}VM Manager - NoxPanel{%% endblock %%}

{%% block extra_css %%}
<style>
.vm-manager-card {
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--card-bg);
}

.vm-manager-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.feature-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px 12px 0 0;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-healthy { background: #28a745; }
.status-warning { background: #ffc107; }
.status-error { background: #dc3545; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.action-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .feature-header {
        padding: 1rem;
    }
}
</style>
{%% endblock %%}

{%% block content %%}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="feature-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0">
                            <i class="fas fa-server me-3"></i>VM Manager
                        </h1>
                        <p class="mb-0 mt-2 opacity-75">Proxmox VM management interface</p>
                    </div>
                    <div class="text-end">
                        <span class="status-indicator status-healthy"></span>
                        <span class="fw-semibold">{{ stats.status|default('Operational')|title }</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_items|default(0) }</div>
            <div class="text-muted">Total Items</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.active_items|default(0) }</div>
            <div class="text-muted">Active</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {%% if stats.last_updated %%}
                    {{ moment(stats.last_updated).fromNow() }}
                {%% else %%}
                    Never
                {%% endif %%}
            </div>
            <div class="text-muted">Last Updated</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-success">âœ“</div>
            <div class="text-muted">Status</div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <div class="col-lg-8">
            <div class="vm-manager-card p-4">
                <h5 class="mb-3">
                    <i class="fas fa-list me-2"></i>VM Manager Overview
                </h5>
                
                {%% if error %%}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Service Initializing:</strong> {{ error }}
                    <br><small class="text-muted">This feature is being set up. Please check back shortly.</small>
                </div>
                {%% else %%}
                <div class="text-center py-5">
                    <i class="fas fa-server fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">VM Manager Ready</h5>
                    <p class="text-muted">This feature has been initialized and is ready for configuration.</p>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Load Data
                    </button>
                </div>
                {%% endif %%}
                
                <!-- Data will be loaded here dynamically -->
                <div id="data-container" class="mt-4" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Action Panel -->
            <div class="action-panel">
                <h6 class="mb-3">
                    <i class="fas fa-tools me-2"></i>Quick Actions
                </h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button class="btn btn-outline-success" onclick="showAddModal()">
                        <i class="fas fa-plus me-2"></i>Add New
                    </button>
                    <button class="btn btn-outline-info" onclick="exportData()">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                    <button class="btn btn-outline-warning" onclick="showSettings()">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </div>
            </div>
            
            <!-- Status Panel -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>System Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Service Status</span>
                        <span class="badge bg-success">Healthy</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Last Check</span>
                        <small class="text-muted">{{ moment().format('HH:mm:ss') }</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Version</span>
                        <small class="text-muted">1.0.0</small>
                    </div>
                </div>
            </div>
            
            <!-- Help Panel -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Getting Started
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        This vm manager module provides comprehensive management capabilities.
                    </p>
                    <ul class="small text-muted mb-0">
                        <li>Use the refresh button to load current data</li>
                        <li>Click "Add New" to create new entries</li>
                        <li>Export data for backup or analysis</li>
                        <li>Configure settings as needed</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label for="itemName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addItem()">Add Item</button>
            </div>
        </div>
    </div>
</div>
{%% endblock %%}

{%% block extra_js %%}
<script>
// VM Manager JavaScript functionality
let currentData = [];

function refreshData() {
    showLoading(true);
    
    fetch('/vm/api/data')
        .then(response => response.json())
        .then(data => {
            currentData = data.items || [];
            updateDataTable();
            document.getElementById('data-container').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showAlert('Error loading data: ' + error.message, 'danger');
        })
        .finally(() => {
            showLoading(false);
        });
}

function updateDataTable() {
    const tableBody = document.getElementById('data-table-body');
    
    if (currentData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No data available. Click "Add New" to get started.
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = currentData.map(item => `
        <tr>
            <td>${item.name || 'Unnamed'}</td>
            <td>
                <span class="badge bg-success">Active</span>
            </td>
            <td>${formatDate(item.updated || new Date())}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editItem('${item.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteItem('${item.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function showAddModal() {
    new bootstrap.Modal(document.getElementById('addModal')).show();
}

function addItem() {
    const form = document.getElementById('addForm');
    const formData = new FormData(form);
    
    // Simulate adding item
    const newItem = {
        id: Date.now(),
        name: formData.get('itemName'),
        description: formData.get('itemDescription'),
        updated: new Date()
    };
    
    currentData.push(newItem);
    updateDataTable();
    
    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
    form.reset();
    
    showAlert('Item added successfully!', 'success');
}

function editItem(id) {
    showAlert('Edit functionality coming soon!', 'info');
}

function deleteItem(id) {
    if (confirm('Are you sure you want to delete this item?')) {
        currentData = currentData.filter(item => item.id != id);
        updateDataTable();
        showAlert('Item deleted successfully!', 'success');
    }
}

function exportData() {
    const dataStr = JSON.stringify(currentData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vm_manager_export.json';
    a.click();
    
    URL.revokeObjectURL(url);
    showAlert('Data exported successfully!', 'success');
}

function showSettings() {
    showAlert('Settings panel coming soon!', 'info');
}

function showLoading(show) {
    // Implementation for loading indicator
}

function showAlert(message, type = 'info') {
    // Create and show alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function formatDate(date) {
    return new Date(date).toLocaleString();
}

// Auto-refresh every 30 seconds
setInterval(refreshData, 30000);

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initial load after a short delay to allow page to settle
    setTimeout(refreshData, 500);
});
</script>
{%% endblock %%}
