<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ NoxPanel v7.0.0 AI Assistant ‚Ä¢ ADHD-Friendly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/version-banner.css') }}" rel="stylesheet">
    <style>
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--bg-secondary);
            transition: var(--theme-transition);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
            position: relative;
        }
        
        .user-message {
            background-color: var(--bg-chat-user);
            color: var(--text-inverse);
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background-color: var(--bg-chat-bot);
            color: var(--text-primary);
            margin-right: auto;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-header {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 6px;
            opacity: 0.8;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        .suggestions {
            margin-top: 15px;
        }
        
        .suggestion-btn {
            margin: 3px;
            font-size: 0.85em;
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        
        .suggestion-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .typing-indicator {
            display: none;
            font-style: italic;
            color: var(--text-muted);
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .chat-input-container {
            margin-top: 20px;
            position: relative;
        }
        
        .chat-input {
            border-radius: 25px;
            padding-left: 20px;
            padding-right: 60px;
            border: 2px solid var(--border-color);
            transition: var(--theme-transition);
        }
        
        .chat-input:focus {
            border-color: var(--bg-button);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .send-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 20px;
            padding: 8px 16px;
        }
        
        .ai-status {
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid var(--bg-button);
            background-color: var(--bg-card);
        }
        
        .status-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: var(--theme-transition);
        }
        
        .provider-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .sidebar {
            background-color: var(--bg-sidebar);
            min-height: 100vh;
            padding: 20px 15px;
        }
        
        .nav-link {
            color: var(--text-inverse);
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px 16px;
            transition: var(--theme-transition);
        }
        
        .nav-link:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-inverse);
        }
        
        .nav-link.active {
            background-color: var(--bg-button);
            color: var(--text-inverse);
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 6px 0;
            font-size: 0.9em;
        }
        
        .quick-commands {
            margin-top: 15px;
        }
        
        .quick-commands small {
            color: var(--text-muted);
            font-weight: 500;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container-fluid">
        <!-- Version 4.3 Feature Announcement Banner -->
        <div class="version-banner">
            <span class="version-tag">ü§ñ AI v4.3</span>
            <strong>ADHD-Friendly AI Assistant with Enhanced Cognitive Support</strong>
            <span class="feature-highlight">üß† Visual Processing</span>
            <span class="feature-highlight">‚ö° Instant Responses</span>
            <span class="feature-highlight">üìù Clear Communication</span>
            <a href="/ai-features">‚Üí Explore All AI Features</a>
        </div>
        
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="sidebar-sticky pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white mb-0">ü§ñ NoxPanel<span class="nav-version-indicator">v4.3</span></h5>
                        <button id="theme-toggle" class="btn btn-sm btn-outline-light" title="Toggle theme">
                            <span class="theme-icon">üåì</span>
                        </button>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                üè† Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/chat">
                                ü§ñ AI Assistant
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/ai-features">
                                üöÄ AI Features Panel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="executeScript('system_diagnostic.py')">
                                üîç System Diagnostic
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showModels()">
                                üß† AI Models
                            </a>
                        </li>
                    </ul>
                    
                    <hr class="text-white-50">
                    <h6 class="text-white-50">AI Features</h6>
                    <ul class="feature-list">
                        <li>‚Ä¢ Natural language commands</li>
                        <li>‚Ä¢ Script execution & analysis</li>
                        <li>‚Ä¢ System diagnostics</li>
                        <li>‚Ä¢ Code assistance & review</li>
                        <li>‚Ä¢ Automated task scheduling</li>
                    </ul>
                    
                    <div class="quick-commands">
                        <small>Quick Commands:</small>
                        <div class="mt-2">
                            <small class="d-block">"Run system check"</small>
                            <small class="d-block">"Show disk usage"</small>
                            <small class="d-block">"List running services"</small>
                            <small class="d-block">"Generate report"</small>
                        </div>
                    </div>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2">ü§ñ AI Assistant</h1>
                        <p class="text-muted mb-0">Natural language system control ‚Ä¢ ADHD-friendly interface</p>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a href="/ai-features" class="btn btn-sm btn-success">üöÄ AI Features</a>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportChat()">üíæ Export</button>
                        </div>
                    </div>
                </div>

                <!-- AI Status Card -->
                <div class="card status-card mb-3">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="ai-status" id="ai-status">
                                    Checking AI providers...
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshConnection()">üîÑ Refresh</button>
                                <button class="btn btn-sm btn-outline-info" onclick="showModelInfo()">‚ÑπÔ∏è Info</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        
                        <!-- Chat Container -->
                        <div class="chat-container" id="chat-container">
                            <div class="message bot-message">
                                <strong>ü§ñ Assistant:</strong><br>
                                Hello! I'm your NoxPanel AI Assistant. I can help you find and run scripts, analyze code, and answer questions about your automation tasks.
                                <br><br>
                                Try asking me things like:
                                <ul>
                                    <li>"Run system diagnostic"</li>
                                    <li>"List available scripts"</li>
                                    <li>"Help me analyze logs"</li>
                                    <li>"What can you do?"</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div class="typing-indicator" id="typing-indicator">
                            ü§ñ Assistant is thinking...
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="chat-input-container">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chat-input" 
                                       placeholder="Ask me anything about your scripts..." 
                                       onkeypress="handleKeyPress(event)">
                                <button class="btn btn-primary" onclick="sendMessage()">
                                    Send
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Suggestions -->
                        <div class="suggestions mt-3" id="quick-suggestions">
                            <small class="text-muted">Quick commands:</small><br>
                            <button class="btn btn-sm btn-outline-secondary suggestion-btn" onclick="sendQuickMessage('help')">
                                Help
                            </button>
                            <button class="btn btn-sm btn-outline-secondary suggestion-btn" onclick="sendQuickMessage('list scripts')">
                                List Scripts
                            </button>
                            <button class="btn btn-sm btn-outline-secondary suggestion-btn" onclick="sendQuickMessage('run system diagnostic')">
                                System Check
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sidebar Info -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>üîß AI Features</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    <li>‚úÖ Natural language script execution</li>
                                    <li>‚úÖ Script recommendations</li>
                                    <li>‚úÖ Code analysis and review</li>
                                    <li>‚úÖ Text summarization</li>
                                    <li>‚úÖ System monitoring help</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>üìä Provider Status</h6>
                            </div>
                            <div class="card-body" id="provider-status">
                                Loading...
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>üí° Tips</h6>
                            </div>
                            <div class="card-body">
                                <small>
                                    ‚Ä¢ Be specific about what you want to do<br>
                                    ‚Ä¢ Ask for help if you're not sure<br>
                                    ‚Ä¢ Use natural language - no need for commands<br>
                                    ‚Ä¢ Check available scripts with "list scripts"
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chatContainer = document.getElementById('chat-container');
        let chatInput = document.getElementById('chat-input');
        let typingIndicator = document.getElementById('typing-indicator');
        
        // Load AI provider status
        loadProviderStatus();
        
        function loadProviderStatus() {
            fetch('/api/chat/providers')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('ai-status');
                    const providerDiv = document.getElementById('provider-status');
                    
                    if (data.status === 'success' && data.providers.length > 0) {
                        statusDiv.innerHTML = `‚úÖ AI Ready (${data.providers.join(', ')})`;
                        statusDiv.className = 'ai-status text-success';
                        
                        let providerHTML = '';
                        data.providers.forEach(provider => {
                            providerHTML += `<span class="badge bg-success me-1">${provider}</span>`;
                        });
                        if (data.default_provider) {
                            providerHTML += `<br><small>Default: ${data.default_provider}</small>`;
                        }
                        providerDiv.innerHTML = providerHTML;
                    } else {
                        statusDiv.innerHTML = '‚ö†Ô∏è No AI providers available';
                        statusDiv.className = 'ai-status text-warning';
                        providerDiv.innerHTML = '<span class="text-muted">No providers configured</span>';
                    }
                })
                .catch(error => {
                    console.error('Error loading provider status:', error);
                    document.getElementById('ai-status').innerHTML = '‚ùå Error checking AI status';
                    document.getElementById('ai-status').className = 'ai-status text-danger';
                });
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function sendQuickMessage(message) {
            chatInput.value = message;
            sendMessage();
        }
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input and show typing indicator
            chatInput.value = '';
            showTypingIndicator();
            
            // Send to API
            fetch('/api/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    user_id: 'web_user'
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                
                if (data.status === 'success') {
                    addMessage(data.response, 'bot');
                    
                    // Add suggestion buttons if available
                    if (data.suggestions && data.suggestions.length > 0) {
                        addSuggestions(data.suggestions);
                    }
                } else {
                    addMessage(`Error: ${data.message || 'Unknown error'}`, 'bot');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            });
        }
        
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const senderLabel = sender === 'user' ? 'üë§ You' : 'ü§ñ Assistant';
            messageDiv.innerHTML = `<strong>${senderLabel}:</strong><br>${formatMessage(text)}`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function addSuggestions(suggestions) {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'message bot-message';
            
            let html = '<strong>üí° Suggested Actions:</strong><br>';
            suggestions.forEach(suggestion => {
                html += `<button class="btn btn-sm btn-outline-primary suggestion-btn me-2 mb-1" 
                         onclick="executeSuggestion('${suggestion.script_name}')">
                         ${suggestion.display_text || suggestion.script_name}
                         </button>`;
            });
            
            suggestionsDiv.innerHTML = html;
            chatContainer.appendChild(suggestionsDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function executeSuggestion(scriptName) {
            sendQuickMessage(`run ${scriptName}`);
        }
        
        function formatMessage(text) {
            // Convert markdown-like formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }
        
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
        }
        
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // Clear chat function
        function clearChat() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = `
                <div class="message bot-message">
                    <div class="message-header">ü§ñ Assistant</div>
                    <div class="message-content">Hello! I'm your NoxPanel AI assistant. I can help you with system administration, script execution, and automation tasks. Try saying something like "run system diagnostic" or "show me disk usage".</div>
                </div>
            `;
        }
        
        // Export chat function
        function exportChat() {
            const chatContainer = document.getElementById('chat-container');
            const messages = chatContainer.querySelectorAll('.message');
            let exportText = 'NoxPanel AI Chat Export\n' + '='.repeat(30) + '\n\n';
            
            messages.forEach((msg, index) => {
                const isUser = msg.classList.contains('user-message');
                const sender = isUser ? 'User' : 'Assistant';
                const content = msg.querySelector('.message-content')?.textContent || msg.textContent;
                exportText += `[${sender}]: ${content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `noxpanel-chat-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Refresh connection function
        function refreshConnection() {
            const statusElement = document.getElementById('ai-status');
            statusElement.innerHTML = 'Refreshing connection...';
            
            fetch('/api/chat/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusElement.innerHTML = `
                            <strong>Provider:</strong> ${data.provider} | 
                            <strong>Model:</strong> ${data.model} | 
                            <strong>Status:</strong> <span class="badge bg-success">üü¢ Connected</span>
                        `;
                    } else {
                        statusElement.innerHTML = `
                            <strong>Status:</strong> <span class="badge bg-danger">üî¥ Disconnected</span> - ${data.message}
                        `;
                    }
                })
                .catch(error => {
                    statusElement.innerHTML = `
                        <strong>Status:</strong> <span class="badge bg-warning">‚ö†Ô∏è Error</span> - Connection failed
                    `;
                });
        }
        
        // Show model info function
        function showModelInfo() {
            fetch('/api/models/providers')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.providers) {
                        let infoText = 'Available AI Models:\n\n';
                        data.providers.forEach(provider => {
                            infoText += `${provider.display_name.toUpperCase()}:\n`;
                            infoText += `  Status: ${provider.installed ? 'Installed' : 'Not Found'}\n`;
                            if (provider.models && provider.models.length > 0) {
                                infoText += `  Models: ${provider.models.join(', ')}\n`;
                            } else {
                                infoText += `  Models: ${provider.model_count} detected\n`;
                            }
                            infoText += '\n';
                        });
                        alert(infoText);
                    } else {
                        alert('No provider data available. Please check your AI model installations.');
                    }
                })
                .catch(error => {
                    console.error('Model info fetch error:', error);
                    alert('Failed to fetch model information: ' + error.message);
                });
        }
        
        // Show models page function
        function showModels() {
            window.open('/api/models', '_blank');
        }
        
        // Execute script function
        function executeScript(scriptName) {
            sendQuickMessage(`run ${scriptName}`);
        }
        
        // Focus input on page load
        chatInput.focus();
        
        // Initialize theme system
        document.addEventListener('DOMContentLoaded', function() {
            // Handle pre-filled message from URL
            const urlParams = new URLSearchParams(window.location.search);
            const preMessage = urlParams.get('message') || '{{ pre_message|default("") }}';
            if (preMessage) {
                chatInput.value = preMessage;
                // Auto-send after a short delay to show user what's happening
                setTimeout(() => {
                    sendMessage();
                }, 1000);
            }
            
            // Check if theme-manager.js is available
            if (typeof ThemeManager !== 'undefined') {
                const themeManager = new ThemeManager();
                themeManager.init();
                
                // Setup theme toggle button
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        themeManager.toggleTheme();
                    });
                }
            } else {
                // Fallback theme toggle if theme-manager.js not available
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', function() {
                        const body = document.body;
                        const currentTheme = body.getAttribute('data-theme') || 'light';
                        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                        body.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                    });
                }
            }
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        });
    </script>
    
    <!-- Include theme manager if available -->
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}" onerror="console.log('Theme manager not available, using fallback')"></script>
</body>
</html>
